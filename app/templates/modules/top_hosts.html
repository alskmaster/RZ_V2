<div class="report-module-instance" {% if new_page %}style="page-break-before: always;"{% endif %}>
    <h2>{{ title or 'Diagn√≥stico dos Principais Ofensores' }}</h2>

    {% if not data.ofensores and not data.summary_chart %}
        <p style="padding: 20px; text-align: center; color: #555; background-color: #f0f0f0; border-radius: 5px;">
            <i>Nenhum host com indisponibilidade registrada no per√≠odo.</i>
        </p>
    {% else %}

        {# Se√ß√£o 1: Gr√°fico Resumo (Controlado pelo Modal) #}
        {% if data.custom_options.show_summary_chart != false %}
            <div class="summary-chart-container" style="page-break-inside: avoid; margin-bottom: 25px; width: 100%;">
                {% if data.summary_chart %}
                    <img src="data:image/png;base64,{{ data.summary_chart }}" style="width: 100%; height: auto;">
                {% else %}
                    <p><i>Gr√°fico de resumo indispon√≠vel.</i></p>
                {% endif %}
            </div>
        {% endif %}

        {# Se√ß√£o 2: Diagn√≥stico Detalhado (Controlado pelo Modal) #}
        {% if data.custom_options.show_detailed_diagnosis != false %}
             <h4 style="font-size: 11pt; color: #333; margin-top: 25px; border-top: 1px solid #ddd; padding-top: 15px;">Diagn√≥stico Individual dos Ofensores do M√™s Atual</h4>
            {% for ofensor in data.ofensores %}
                <div class="ofensor-card" style="page-break-inside: avoid; margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 5px; padding: 15px; background-color: #f9f9f9;">
                    
                    <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14pt; color: #c62828; border-bottom: 1px solid #e0e0e0; padding-bottom: 5px;">
                        üñ•Ô∏è {{ ofensor.name }}
                    </h3>
                    
                    <table class="table" style="font-size: 8pt; margin-bottom: 15px; table-layout: fixed; width: 100%;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="width: 60%;">M√©trica</th>
                            <th style="width: 40%;">Valor</th>
                        </tr>
                        <tr>
                            <td><strong>Tempo Indispon√≠vel (M√™s Atual)</strong></td>
                            <td>{{ ofensor.downtime_str }}</td>
                        </tr>
                        <tr>
                            <td><strong>N¬∫ Total de Incidentes (Todos os Tipos)</strong></td>
                            <td>{{ ofensor.total_incidents }}</td>
                        </tr>
                    </table>

                    <h5 style="font-size: 10pt; color: #333; margin-bottom: 10px;">Breakdown de Causa Raiz (por frequ√™ncia):</h5>
                    
                    {% set chart_type = data.custom_options.chart_type or 'table' %}

                    {% if (chart_type == 'pie' or chart_type == 'bar') and ofensor.breakdown_chart %}
                        <div class="breakdown-chart" style="text-align: center;">
                             <img src="data:image/png;base64,{{ ofensor.breakdown_chart }}" style="max-width: 100%; height: auto;">
                        </div>

                    {% elif chart_type == 'table' %}
                        <table class="table" style="font-size: 8pt;">
                            <thead>
                                <tr>
                                    <th>Tipo de Incidente</th>
                                    <th style="width: 25%;">Ocorr√™ncias</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for problema, ocorrencias in ofensor.breakdown.items() %}
                                <tr>
                                    <td>{{ problema }}</td>
                                    <td>{{ ocorrencias }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="font-size: 9pt; color: #777; font-style: italic;">Nenhum incidente detalhado encontrado para este host.</p>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    {% endif %}
</div>