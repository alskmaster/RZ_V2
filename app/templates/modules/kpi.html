<div class="report-module-instance" {% if new_page %}style="page-break-before: always;"{% endif %}>
    <h2 class="first">{{ title or 'Indicadores Chave de Disponibilidade (KPIs)' }}</h2>

    <style>
        @font-face {
            font-family: 'Roboto';
            src: url('/static/fonts/Roboto-Regular.ttf') format('truetype');
        }
        .kpi-grid-embed {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            margin-top: 20px;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        .kpi-card-embed {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            border-left-width: 5px;
            width: 48%;
            display: -webkit-flex;
            display: flex;
            align-items: center;
            page-break-inside: avoid;
        }
        .kpi-card-embed:last-child {
            margin-bottom: 0;
        }

        .kpi-card-embed.status-atingido { border-left-color: #28a745; }
        .kpi-card-embed.status-nao-atingido { border-left-color: #dc3545; }
        .kpi-card-embed.status-critico { border-left-color: #ffc107; }
        .kpi-card-embed.status-ok { border-left-color: #17a2b8; }
        .kpi-card-embed.status-info { border-left-color: #6c757d; }

        .kpi-icon-embed {
            margin-right: 15px;
            flex-shrink: 0;
        }
        .kpi-icon-embed svg {
            width: 40px;
            height: 40px;
        }

        .kpi-text-content {
            flex-grow: 1; /* Faz o conteúdo de texto ocupar o espaço disponível */
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            justify-content: center;
            align-items: center; 
            text-align: center; 
            overflow: hidden;
        }

        .kpi-value-embed {
            font-size: 2em;
            font-weight: bold;
            margin: 0; padding: 0; line-height: 1.1;
            word-wrap: break-word;
        }
        .kpi-card-embed.status-atingido .kpi-value-embed { color: #28a745; }
        .kpi-card-embed.status-nao-atingido .kpi-value-embed { color: #dc3545; }
        .kpi-card-embed.status-critico .kpi-value-embed { color: #ffc107; }
        .kpi-card-embed.status-ok .kpi-value-embed { color: #17a2b8; }
        .kpi-card-embed.status-info .kpi-value-embed { color: #343a40; }

        .kpi-label-embed {
            font-size: 0.95em;
            font-weight: 500;
            color: #495057;
            margin: 0;
            display: -webkit-flex;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kpi-sublabel-embed {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }
        .kpi-value-small-embed {
           font-size: 1.3em;
           font-weight: normal;
        }
        .kpi-trend-embed {
            font-size: 1.2em;
            font-weight: bold;
            margin-left: 8px;
        }
        .kpi-trend-embed.trend-up {
            color: #28a745;
        }
        .kpi-trend-embed.trend-down {
            color: #dc3545;
        }

        .incident-severity-chart {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            page-break-inside: avoid;
        }
        .incident-severity-chart h3 {
            font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin-top: 0;
            margin-bottom: 15px;
            color: #495057;
            text-align: center;
            font-weight: 400;
        }
    </style>

    <div class="kpi-grid-embed">
        {% set icons = {
            'Média de SLA': '<svg xmlns="http://www.w3.org/2000/svg" fill="#6c757d" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4.303 6H4a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-.303a4.002 4.002 0 0 0-2.902-3.92L8 1.918zM14 8v3h-1v-1a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v1H4V8h10z"/></svg>',
            'Hosts com SLA': '<svg xmlns="http://www.w3.org/2000/svg" fill="#ffc107" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>',
            'Total de Incidentes': '<svg xmlns="http://www.w3.org/2000/svg" fill="#6c757d" viewBox="0 0 16 16"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10 1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1z"/><path d="M4.5 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/></svg>',
            'Principal Ofensor': '<svg xmlns="http://www.w3.org/2000/svg" fill="#343a40" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg>'
        } %}

        {% for kpi in data.kpis_data %}
        <div class="kpi-card-embed status-{{ kpi.status }}">
            <div class="kpi-icon-embed">
                {% if 'SLA' in kpi.label %}
                    {{ icons['Média de SLA'] | safe }}
                {% elif 'Hosts' in kpi.label %}
                    {{ icons['Hosts com SLA'] | safe }}
                {% elif 'Incidentes' in kpi.label %}
                    {{ icons['Total de Incidentes'] | safe }}
                {% elif 'Ofensor' in kpi.label %}
                    {{ icons['Principal Ofensor'] | safe }}
                {% endif %}
            </div>
            <div class="kpi-text-content">
                <p class="kpi-label-embed">
                    {{ kpi.label }}
                    {% if kpi.trend == 'up' %}
                        <span class="kpi-trend-embed trend-up" title="Melhorou em relação ao mês anterior">▲</span>
                    {% elif kpi.trend == 'down' %}
                        <span class="kpi-trend-embed trend-down" title="Piorou em relação ao mês anterior">▼</span>
                    {% endif %}
                </p>
                {% if 'Ofensor' in kpi.label %}
                    <p class="kpi-value-embed kpi-value-small-embed">{{ kpi.value }}</p>
                {% else %}
                    <p class="kpi-value-embed">{{ kpi.value }}</p>
                {% endif %}
                <p class="kpi-sublabel-embed">{{ kpi.sublabel }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="incident-severity-chart">
        <h3>Incidentes por Severidade</h3>
        {% if data.pie_chart_base64 %}
            <img src="data:image/png;base64,{{ data.pie_chart_base64 }}" style="width: 100%; height: auto; max-width: 600px; margin: 0 auto; display: block;">
        {% else %}
            <p style="text-align: center; color: #6c757d;"><i>Nenhum incidente com severidade definida foi registrado no período.</i></p>
        {% endif %}
        </div>
</div>